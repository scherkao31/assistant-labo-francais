<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant Médical - Laboratoire de Biologie</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-microscope"></i>
                    <h1>Assistant Médical</h1>
                </div>
                <p class="subtitle">Laboratoire de Biologie Clinique - Belgique</p>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="tabs-nav">
            <div class="tabs-container">
                <button class="tab-btn active" onclick="switchTab('compendium')">
                    <i class="fas fa-book-medical"></i>
                    <span>Compendium</span>
                </button>
                <button class="tab-btn" onclick="switchTab('admin')">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Admin</span>
                </button>
                <button class="tab-btn" onclick="switchTab('hemato')">
                    <i class="fas fa-tint"></i>
                    <span>Hémato</span>
                </button>
                <button class="tab-btn" onclick="switchTab('microbio')">
                    <i class="fas fa-bacteria"></i>
                    <span>Microbio</span>
                </button>
                <button class="tab-btn" onclick="switchTab('chimie')">
                    <i class="fas fa-flask"></i>
                    <span>Chimie</span>
                </button>
            </div>
        </nav>

        <main class="main-content">
            <!-- Compendium Tab -->
            <div id="compendium-tab" class="tab-content active">
                <div class="chat-container">
                    <div class="welcome-message" id="compendiumWelcome">
                        <div class="welcome-icon">
                            <i class="fas fa-book-medical"></i>
                        </div>
                        <h2>Compendium des Analyses - Belgique</h2>
                        <p>Recherchez des informations sur les analyses de laboratoire disponibles dans les hôpitaux belges. Je vous fournirai les liens directs vers les pages officielles des laboratoires.</p>
                        <div class="example-questions">
                            <h3>Exemples de recherches :</h3>
                            <div class="question-examples">
                                <button class="example-btn" onclick="setQuestion('Analyse de glucose')">
                                    <i class="fas fa-vial"></i>
                                    Analyse de glucose
                                </button>
                                <button class="example-btn" onclick="setQuestion('Test de cholestérol')">
                                    <i class="fas fa-heartbeat"></i>
                                    Test de cholestérol
                                </button>
                                <button class="example-btn" onclick="setQuestion('Analyses pour diabète')">
                                    <i class="fas fa-search"></i>
                                    Analyses pour diabète
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="messages" id="compendiumMessages"></div>

                    <div class="loading" id="compendiumLoading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Recherche dans le compendium belge...</p>
                    </div>
                </div>

                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            id="compendiumInput" 
                            placeholder="Recherchez une analyse de laboratoire..."
                            rows="3"
                            maxlength="500"
                        ></textarea>
                        <div class="input-actions">
                            <span class="char-counter" id="compendiumCharCounter">0/500</span>
                            <button id="compendiumSubmitBtn" class="submit-btn" onclick="askCompendium()">
                                <i class="fas fa-search"></i>
                                Rechercher
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coming Soon Tabs -->
            <div id="admin-tab" class="tab-content">
                <div class="coming-soon">
                    <div class="coming-soon-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <h2>Module Administratif</h2>
                    <p>Ce module est en cours de développement et sera bientôt disponible.</p>
                    <div class="features-preview">
                        <h3>Fonctionnalités à venir :</h3>
                        <ul>
                            <li><i class="fas fa-check"></i> Procédures administratives</li>
                            <li><i class="fas fa-check"></i> Gestion des délais</li>
                            <li><i class="fas fa-check"></i> Protocoles de validation</li>
                            <li><i class="fas fa-check"></i> Conformité réglementaire</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="hemato-tab" class="tab-content">
                <div class="coming-soon">
                    <div class="coming-soon-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <h2>Module Hématologie</h2>
                    <p>Ce module est en cours de développement et sera bientôt disponible.</p>
                    <div class="features-preview">
                        <h3>Fonctionnalités à venir :</h3>
                        <ul>
                            <li><i class="fas fa-check"></i> Analyses hématologiques</li>
                            <li><i class="fas fa-check"></i> Interprétation des résultats</li>
                            <li><i class="fas fa-check"></i> Cas cliniques</li>
                            <li><i class="fas fa-check"></i> Valeurs de référence</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="microbio-tab" class="tab-content">
                <div class="coming-soon">
                    <div class="coming-soon-icon">
                        <i class="fas fa-bacteria"></i>
                    </div>
                    <h2>Module Microbiologie</h2>
                    <p>Ce module est en cours de développement et sera bientôt disponible.</p>
                    <div class="features-preview">
                        <h3>Fonctionnalités à venir :</h3>
                        <ul>
                            <li><i class="fas fa-check"></i> Analyses microbiologiques</li>
                            <li><i class="fas fa-check"></i> Antibiogrammes</li>
                            <li><i class="fas fa-check"></i> Identification bactérienne</li>
                            <li><i class="fas fa-check"></i> Protocoles de culture</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="chimie-tab" class="tab-content">
                <div class="coming-soon">
                    <div class="coming-soon-icon">
                        <i class="fas fa-flask"></i>
                    </div>
                    <h2>Module Chimie Clinique</h2>
                    <p>Ce module est en cours de développement et sera bientôt disponible.</p>
                    <div class="features-preview">
                        <h3>Fonctionnalités à venir :</h3>
                        <ul>
                            <li><i class="fas fa-check"></i> Analyses biochimiques</li>
                            <li><i class="fas fa-check"></i> Dosages hormonaux</li>
                            <li><i class="fas fa-check"></i> Marqueurs cardiaques</li>
                            <li><i class="fas fa-check"></i> Bilan métabolique</li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <div class="footer-content">
                <div class="status-indicator" id="statusIndicator">
                    <i class="fas fa-circle"></i>
                    <span>Vérification du statut...</span>
                </div>
                <div class="footer-links">
                    <button class="link-btn" onclick="showSources()">
                        <i class="fas fa-database"></i>
                        Sources disponibles
                    </button>
                    <button class="link-btn" onclick="clearChat()">
                        <i class="fas fa-trash"></i>
                        Vider la conversation
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal pour afficher les sources -->
    <div class="modal" id="sourcesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Sources disponibles</h2>
                <button class="close-btn" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="sourcesContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Chargement des sources...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let isLoading = false;
        let messageCount = 0;
        let currentTab = 'compendium';

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            checkStatus();
            setupEventListeners();
            updateCharCounter();
        });

        // Gestion des onglets
        function switchTab(tabName) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Masquer tous les boutons d'onglet
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Afficher l'onglet sélectionné
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.closest('.tab-btn').classList.add('active');
            
            currentTab = tabName;
        }

        // Configuration des événements
        function setupEventListeners() {
            const input = document.getElementById('compendiumInput');
            const submitBtn = document.getElementById('compendiumSubmitBtn');
            
            // Soumission par Enter (avec Shift+Enter pour nouvelle ligne)
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    askCompendium();
                }
            });

            // Compteur de caractères
            input.addEventListener('input', updateCharCounter);

            // Fermeture du modal en cliquant à l'extérieur
            window.addEventListener('click', function(e) {
                const modal = document.getElementById('sourcesModal');
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        // Vérification du statut de l'application
        function checkStatus() {
            fetch('/api/health')
                .then(response => response.json())
                .then(data => {
                    const indicator = document.getElementById('statusIndicator');
                    if (data.success) {
                        indicator.innerHTML = `
                            <i class="fas fa-circle status-online"></i>
                            <span>Prêt - ${data.database_documents} documents chargés</span>
                        `;
                    } else {
                        indicator.innerHTML = `
                            <i class="fas fa-circle status-offline"></i>
                            <span>Erreur - ${data.error}</span>
                        `;
                    }
                })
                .catch(error => {
                    document.getElementById('statusIndicator').innerHTML = `
                        <i class="fas fa-circle status-offline"></i>
                        <span>Déconnecté - Impossible de vérifier le statut</span>
                    `;
                });
        }

        // Mise à jour du compteur de caractères
        function updateCharCounter() {
            const input = document.getElementById('compendiumInput');
            const counter = document.getElementById('compendiumCharCounter');
            const length = input.value.length;
            counter.textContent = `${length}/500`;
            
            if (length > 400) {
                counter.classList.add('warning');
            } else {
                counter.classList.remove('warning');
            }
        }

        // Définir une question exemple
        function setQuestion(question) {
            document.getElementById('compendiumInput').value = question;
            updateCharCounter();
            document.getElementById('compendiumInput').focus();
        }

        // Poser une question au compendium
        function askCompendium() {
            if (isLoading) return;

            const input = document.getElementById('compendiumInput');
            const question = input.value.trim();

            if (!question) {
                showError('Veuillez saisir une recherche');
                return;
            }

            // Cacher le message d'accueil
            document.getElementById('compendiumWelcome').style.display = 'none';

            // Afficher la question de l'utilisateur
            addMessage('user', question);

            // Vider le champ de saisie
            input.value = '';
            updateCharCounter();

            // Afficher le loading
            setLoading(true);

            // Envoyer la question au compendium
            fetch('/api/compendium', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question
                })
            })
            .then(response => response.json())
            .then(data => {
                setLoading(false);
                
                if (data.success) {
                    addMessage('assistant', data.answer, data.sources);
                } else {
                    addMessage('assistant', `Erreur: ${data.error}`);
                }
            })
            .catch(error => {
                setLoading(false);
                addMessage('assistant', 'Erreur de connexion. Veuillez réessayer.');
                console.error('Erreur:', error);
            });
        }

        // Ajouter un message à la conversation
        function addMessage(sender, content, sources = null) {
            const messagesContainer = document.getElementById('compendiumMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.id = `message-${++messageCount}`;

            let sourcesHtml = '';
            if (sources && sources.length > 0) {
                sourcesHtml = `
                    <div class="sources">
                        <h4><i class="fas fa-link"></i> Liens vers les laboratoires:</h4>
                        <div class="source-list">
                            ${sources.map(source => `
                                <div class="source-item">
                                    <a href="${source.url}" target="_blank" class="source-link">
                                        <i class="fas fa-external-link-alt"></i>
                                        ${source.title} - ${source.lab}
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-sender">
                        <i class="fas ${sender === 'user' ? 'fa-user' : 'fa-robot'}"></i>
                        ${sender === 'user' ? 'Vous' : 'Compendium'}
                    </div>
                    <div class="message-time">${new Date().toLocaleTimeString('fr-FR')}</div>
                </div>
                <div class="message-content">
                    ${content.replace(/\n/g, '<br>')}
                </div>
                ${sourcesHtml}
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Gérer l'état de chargement
        function setLoading(loading) {
            isLoading = loading;
            const loadingDiv = document.getElementById('compendiumLoading');
            const submitBtn = document.getElementById('compendiumSubmitBtn');
            
            if (loading) {
                loadingDiv.style.display = 'block';
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Recherche...';
            } else {
                loadingDiv.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-search"></i> Rechercher';
            }
        }

        // Afficher les sources
        function showSources() {
            const modal = document.getElementById('sourcesModal');
            const content = document.getElementById('sourcesContent');
            
            modal.style.display = 'block';
            content.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Chargement des sources...</p>
                </div>
            `;

            fetch('/api/sources')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        content.innerHTML = `
                            <div class="sources-list">
                                ${data.sources.map(source => `
                                    <div class="source-card">
                                        <h3>${source.title}</h3>
                                        <p><strong>Fichier:</strong> ${source.filename}</p>
                                        <p><strong>Sections:</strong> ${source.chunk_count}</p>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        content.innerHTML = `<p class="error">Erreur: ${data.error}</p>`;
                    }
                })
                .catch(error => {
                    content.innerHTML = `<p class="error">Erreur de connexion</p>`;
                });
        }

        // Fermer le modal
        function closeModal() {
            document.getElementById('sourcesModal').style.display = 'none';
        }

        // Vider la conversation
        function clearChat() {
            if (confirm('Êtes-vous sûr de vouloir vider la conversation ?')) {
                document.getElementById('compendiumMessages').innerHTML = '';
                document.getElementById('compendiumWelcome').style.display = 'block';
                messageCount = 0;
            }
        }

        // Afficher une erreur
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-toast';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html> 