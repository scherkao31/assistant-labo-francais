<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant M√©dical Belge - Clinique Saint-Pierre Ottignies</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-hospital"></i>
                    <h1>Assistant M√©dical Belge</h1>
                </div>
                <p class="subtitle">Clinique Saint-Pierre Ottignies - Compendium des Analyses Biologiques</p>
            </div>
        </header>

        <nav class="tabs-nav">
            <div class="tabs-container">
                <button class="tab-btn active" data-tab="compendium">
                    <i class="fas fa-flask"></i>
                    Compendium
                </button>
                <button class="tab-btn" data-tab="admin">
                    <i class="fas fa-clipboard-list"></i>
                    Admin
                </button>
                <button class="tab-btn" data-tab="hemato">
                    <i class="fas fa-tint"></i>
                    H√©mato
                </button>
                <button class="tab-btn" data-tab="microbio">
                    <i class="fas fa-microscope"></i>
                    Microbio
                </button>
                <button class="tab-btn" data-tab="chimie">
                    <i class="fas fa-vial"></i>
                    Chimie
                </button>
            </div>
        </nav>

        <main class="main-content">
            <!-- Onglet Compendium -->
            <div id="compendium" class="tab-content active">
                <div class="chat-container">
                    <div class="welcome-message">
                        <div class="welcome-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h2>Recherche dans le Compendium Belge</h2>
                        <p>Trouvez rapidement les analyses biologiques disponibles dans les laboratoires belges partenaires. Notre base de donn√©es contient plus de 7 000 analyses provenant des principaux laboratoires du pays.</p>
                        
                        <div class="example-questions">
                            <h3>Exemples de questions</h3>
                            <div class="question-examples">
                                <button class="example-btn" onclick="fillExample('Je veux faire une PCR Chlamydia pneumoniae sur LBA o√π je peux l\'envoyer ?')">
                                    <i class="fas fa-dna"></i>
                                    <span>PCR Chlamydia pneumoniae sur LBA</span>
                                </button>
                                <button class="example-btn" onclick="fillExample('O√π puis-je envoyer une s√©rologie Lyme ?')">
                                    <i class="fas fa-bug"></i>
                                    <span>S√©rologie Lyme</span>
                                </button>
                                <button class="example-btn" onclick="fillExample('Analyse de liquide c√©phalo-rachidien')">
                                    <i class="fas fa-brain"></i>
                                    <span>Liquide c√©phalo-rachidien</span>
                                </button>
                                <button class="example-btn" onclick="fillExample('Test de r√©sistance aux antibiotiques')">
                                    <i class="fas fa-shield-virus"></i>
                                    <span>R√©sistance aux antibiotiques</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="messages" id="messages"></div>
                </div>
                
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            id="compendiumInput" 
                            placeholder="Posez votre question sur les analyses biologiques belges..."
                            maxlength="500"
                        ></textarea>
                    </div>
                    <div class="input-actions">
                        <div class="char-counter">
                            <span id="charCount">0</span>/500 caract√®res
                        </div>
                        <button class="submit-btn" id="submitBtn">
                            <i class="fas fa-paper-plane"></i>
                            Rechercher
                        </button>
                    </div>
                </div>
            </div>

            <!-- Onglet Admin -->
            <div id="admin" class="tab-content">
                <div class="coming-soon">
                    <div class="coming-soon-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <h2>Proc√©dures Administratives</h2>
                    <p>Bient√¥t disponible : gestion des proc√©dures administratives, formulaires de demande, et suivi des analyses.</p>
                    <div class="features-preview">
                        <h3>Fonctionnalit√©s pr√©vues</h3>
                        <ul>
                            <li><i class="fas fa-check"></i> Formulaires de demande d'analyses</li>
                            <li><i class="fas fa-check"></i> Suivi des √©chantillons</li>
                            <li><i class="fas fa-check"></i> Gestion des urgences</li>
                            <li><i class="fas fa-check"></i> Nomenclature INAMI</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Onglet H√©mato -->
            <div id="hemato" class="tab-content">
                <div class="coming-soon">
                    <div class="coming-soon-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <h2>H√©matologie</h2>
                    <p>Module sp√©cialis√© pour l'h√©matologie : analyses sanguines, coagulation, et h√©mostase.</p>
                    <div class="features-preview">
                        <h3>Fonctionnalit√©s pr√©vues</h3>
                        <ul>
                            <li><i class="fas fa-check"></i> Analyses h√©matologiques compl√®tes</li>
                            <li><i class="fas fa-check"></i> Tests de coagulation</li>
                            <li><i class="fas fa-check"></i> H√©mostase et thrombose</li>
                            <li><i class="fas fa-check"></i> Interpr√©tation des r√©sultats</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Onglet Microbio -->
            <div id="microbio" class="tab-content">
                <div class="coming-soon">
                    <div class="coming-soon-icon">
                        <i class="fas fa-microscope"></i>
                    </div>
                    <h2>Microbiologie</h2>
                    <p>Assistant sp√©cialis√© en microbiologie : bact√©riologie, virologie, parasitologie et mycologie.</p>
                    <div class="features-preview">
                        <h3>Fonctionnalit√©s pr√©vues</h3>
                        <ul>
                            <li><i class="fas fa-check"></i> Identification bact√©rienne</li>
                            <li><i class="fas fa-check"></i> Antibiogrammes</li>
                            <li><i class="fas fa-check"></i> Virologie mol√©culaire</li>
                            <li><i class="fas fa-check"></i> Parasitologie clinique</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Onglet Chimie -->
            <div id="chimie" class="tab-content">
                <div class="coming-soon">
                    <div class="coming-soon-icon">
                        <i class="fas fa-vial"></i>
                    </div>
                    <h2>Chimie Clinique</h2>
                    <p>Module d√©di√© √† la chimie clinique : biochimie, toxicologie, et analyses sp√©cialis√©es.</p>
                    <div class="features-preview">
                        <h3>Fonctionnalit√©s pr√©vues</h3>
                        <ul>
                            <li><i class="fas fa-check"></i> Biochimie g√©n√©rale</li>
                            <li><i class="fas fa-check"></i> Marqueurs cardiaques</li>
                            <li><i class="fas fa-check"></i> Toxicologie clinique</li>
                            <li><i class="fas fa-check"></i> Dosages hormonaux</li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <div class="footer-content">
                <div class="status-indicator">
                    <i class="fas fa-circle status-online"></i>
                    <span>Syst√®me op√©rationnel</span>
                </div>
                <div class="footer-links">
                    <button class="link-btn" onclick="showSourcesModal()">
                        <i class="fas fa-database"></i>
                        Sources
                    </button>
                    <button class="link-btn" onclick="showHelpModal()">
                        <i class="fas fa-question-circle"></i>
                        Aide
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal Sources -->
    <div id="sourcesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Sources de Donn√©es</h2>
                <button class="close-btn" onclick="closeModal('sourcesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="sources-list">
                    <div class="source-card">
                        <h3>LHUB-ULB</h3>
                        <p>Laboratoire Hospitalier Universitaire de Bruxelles</p>
                        <p>Plus de 4 000 analyses disponibles</p>
                    </div>
                    <div class="source-card">
                        <h3>UZA Antwerpen</h3>
                        <p>Universitair Ziekenhuis Antwerpen</p>
                        <p>Analyses sp√©cialis√©es et de routine</p>
                    </div>
                    <div class="source-card">
                        <h3>CHU ULG</h3>
                        <p>Centre Hospitalier Universitaire de Li√®ge</p>
                        <p>Laboratoire de r√©f√©rence</p>
                    </div>
                    <div class="source-card">
                        <h3>CHR Citadelle</h3>
                        <p>Centre Hospitalier R√©gional de la Citadelle</p>
                        <p>Analyses de proximit√©</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Aide -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Guide d'Utilisation</h2>
                <button class="close-btn" onclick="closeModal('helpModal')">&times;</button>
            </div>
            <div class="modal-body">
                <h3>Comment utiliser l'assistant ?</h3>
                <p>Posez vos questions en langage naturel sur les analyses biologiques disponibles dans les laboratoires belges.</p>
                
                <h3>Exemples de questions</h3>
                <ul>
                    <li>¬´ O√π puis-je envoyer une PCR pour Chlamydia ? ¬ª</li>
                    <li>¬´ Analyse de liquide c√©phalo-rachidien ¬ª</li>
                    <li>¬´ Test de r√©sistance aux antibiotiques ¬ª</li>
                </ul>
                
                <h3>Informations fournies</h3>
                <ul>
                    <li>Laboratoires disponibles</li>
                    <li>Liens directs vers les pages des analyses</li>
                    <li>Informations sur les pr√©l√®vements</li>
                    <li>Techniques utilis√©es</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentTab = 'compendium';
        let isLoading = false;

        // Gestion des onglets
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                switchTab(tabId);
            });
        });

        function switchTab(tabId) {
            // D√©sactiver tous les onglets
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activer l'onglet s√©lectionn√©
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            currentTab = tabId;
        }

        // Gestion du compteur de caract√®res
        const input = document.getElementById('compendiumInput');
        const charCount = document.getElementById('charCount');
        const submitBtn = document.getElementById('submitBtn');

        input.addEventListener('input', () => {
            const count = input.value.length;
            charCount.textContent = count;
            
            if (count > 400) {
                charCount.parentElement.classList.add('warning');
            } else {
                charCount.parentElement.classList.remove('warning');
            }
        });

        // Gestion de la soumission
        submitBtn.addEventListener('click', () => {
            if (currentTab === 'compendium') {
                submitCompendiumQuestion();
            }
        });

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (currentTab === 'compendium') {
                    submitCompendiumQuestion();
                }
            }
        });

        // Fonction pour remplir un exemple
        function fillExample(text) {
            input.value = text;
            charCount.textContent = text.length;
            input.focus();
        }

        // Soumission pour le compendium
        async function submitCompendiumQuestion() {
            const question = input.value.trim();
            if (!question || isLoading) return;

            isLoading = true;
            submitBtn.disabled = true;
            
            // Ajouter le message utilisateur
            addMessage('user', question);
            
            // Vider l'input
            input.value = '';
            charCount.textContent = '0';
            
            // Afficher le loading
            showLoading();
            
            try {
                const response = await fetch('/api/compendium', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question })
                });
                
                const data = await response.json();
                
                hideLoading();
                
                if (data.success) {
                    addMessage('assistant', data.answer, data.sources);
                } else {
                    addMessage('assistant', 'D√©sol√©, une erreur s\'est produite. Veuillez r√©essayer.');
                }
            } catch (error) {
                hideLoading();
                addMessage('assistant', 'Erreur de connexion. Veuillez v√©rifier votre connexion internet.');
                console.error('Erreur:', error);
            } finally {
                isLoading = false;
                submitBtn.disabled = false;
            }
        }

        // Gestion des messages
        function addMessage(sender, content, sources = null) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            let sourcesHtml = '';
            if (sources && sources.length > 0) {
                sourcesHtml = `
                    <div class="sources">
                        <h4><i class="fas fa-link"></i> Liens vers les laboratoires:</h4>
                        <div class="source-list">
                            ${sources.map(source => `
                                <div class="source-item">
                                    <div class="source-header">
                                        <a href="${source.url}" target="_blank" class="source-link">
                                            <i class="fas fa-external-link-alt"></i>
                                            ${source.title}
                                        </a>
                                        <span class="source-lab">${source.lab}</span>
                                    </div>
                                    ${source.description ? `<div class="source-description"><strong>Description:</strong> ${source.description}</div>` : ''}
                                    ${source.prelevement ? `<div class="source-prelevement"><strong>Pr√©l√®vement:</strong> ${source.prelevement}</div>` : ''}
                                    ${source.technique ? `<div class="source-technique"><strong>Technique:</strong> ${source.technique}</div>` : ''}
                                    <div class="source-score">Pertinence: ${Math.round(source.score * 100)}%</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-sender">
                        <i class="fas fa-${sender === 'user' ? 'user' : 'robot'}"></i>
                        ${sender === 'user' ? 'Vous' : 'Assistant'}
                    </div>
                    <div class="message-time">${timeString}</div>
                </div>
                <div class="message-content">${formatMessage(content)}</div>
                ${sourcesHtml}
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatMessage(content) {
            // Am√©liorer le formatage du texte
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>')
                .replace(/(\d+\.\s)/g, '<br>$1'); // Num√©rotation sur nouvelle ligne
        }

        function showLoading() {
            const messagesContainer = document.getElementById('messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-message';
            loadingDiv.className = 'message assistant';
            loadingDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-sender">
                        <i class="fas fa-robot"></i>
                        Assistant
                    </div>
                    <div class="message-time">${new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</div>
                </div>
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Recherche dans le compendium...</span>
                </div>
            `;
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideLoading() {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        // Gestion des modales
        function showSourcesModal() {
            document.getElementById('sourcesModal').style.display = 'block';
        }

        function showHelpModal() {
            document.getElementById('helpModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Fermer les modales en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Gestion des erreurs
        window.addEventListener('error', (e) => {
            console.error('Erreur JavaScript:', e.error);
            if (isLoading) {
                hideLoading();
                addMessage('assistant', 'Une erreur inattendue s\'est produite. Veuillez actualiser la page.');
                isLoading = false;
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html> 